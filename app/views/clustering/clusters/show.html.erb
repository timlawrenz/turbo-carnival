<div class="container mx-auto px-4 py-8">
  <!-- Back button -->
  <div class="mb-4">
    <% if @pillar %>
      <%= link_to persona_pillar_path(@persona, @pillar), class: "text-blue-600 hover:text-blue-800" do %>
        ‚Üê Back to <%= @pillar.name %>
      <% end %>
    <% else %>
      <%= link_to persona_path(@persona), class: "text-blue-600 hover:text-blue-800" do %>
        ‚Üê Back to <%= @persona.name.titleize %>
      <% end %>
    <% end %>
  </div>

  <h1 class="text-3xl font-bold mb-2"><%= @cluster.name %></h1>
  <div class="text-zinc-400 mb-4">
    <% if @pillar %>
      <span class="inline-block bg-zinc-700 rounded px-3 py-1"><%= @pillar.name %></span>
    <% end %>
    <span class="ml-2">Status: <%= @cluster.status %></span>
  </div>
  
  <% if @cluster.ai_prompt.present? %>
    <%= render CardComponent.new(classes: "mb-8") do |c| %>
      <% c.with_body do %>
        <h3 class="font-semibold mb-2">AI Prompt</h3>
        <p class="text-zinc-300"><%= @cluster.ai_prompt %></p>
      <% end %>
    <% end %>
  <% end %>

  <!-- Stats -->
  <div class="grid grid-cols-2 gap-4 mb-8">
    <%= render CardComponent.new do |c| %>
      <% c.with_body do %>
        <div class="text-2xl font-bold"><%= @photos.count %></div>
        <div class="text-zinc-400">Photos</div>
      <% end %>
    <% end %>
    <%= render CardComponent.new do |c| %>
      <% c.with_body do %>
        <div class="text-2xl font-bold"><%= @runs.count %></div>
        <div class="text-zinc-400">Runs</div>
      <% end %>
    <% end %>
  </div>

  <!-- Upload Photos Section -->
  <%= render CardComponent.new(classes: "mb-8") do |c| %>
    <% c.with_body do %>
      <h3 class="text-xl font-semibold mb-4">üì§ Upload Photos</h3>
      <form id="photo-upload-form" data-cluster-id="<%= @cluster.id %>">
        <div class="mb-4">
          <label class="block mb-2">
            <span class="text-zinc-300">Select photos to upload (JPG, PNG, WEBP - Max 10MB each)</span>
            <input 
              type="file" 
              name="photos[]" 
              multiple 
              accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp"
              class="mt-2 block w-full text-sm text-zinc-400
                     file:mr-4 file:py-2 file:px-4
                     file:rounded file:border-0
                     file:text-sm file:font-semibold
                     file:bg-purple-600 file:text-white
                     hover:file:bg-purple-700
                     cursor-pointer"
            />
          </label>
        </div>
        
        <div id="upload-feedback" class="mb-4 hidden"></div>
        
        <button 
          type="submit"
          class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
          id="upload-button"
        >
          Upload Photos
        </button>
        
        <div id="upload-progress" class="mt-4 hidden">
          <div class="w-full bg-zinc-700 rounded-full h-2">
            <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p class="text-sm text-zinc-400 mt-2">Uploading...</p>
        </div>
      </form>
    <% end %>
  <% end %>

  <!-- Photos -->
  <% if @photos.any? %>
    <h2 class="text-2xl font-semibold mb-4">Photos</h2>
    <div id="photos-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
      <% @photos.each do |photo| %>
        <div class="border rounded-lg overflow-hidden">
          <% if photo.image.attached? %>
            <%= image_tag photo.image, class: "w-full h-48 object-cover" %>
          <% else %>
            <div class="w-full h-48 bg-zinc-200 flex items-center justify-center text-zinc-500">
              No image
            </div>
          <% end %>
          <div class="p-2 text-xs text-zinc-600">
            <%= photo.created_at.strftime('%b %d') %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Runs -->
  <h2 class="text-2xl font-semibold mb-4">Pipeline Runs</h2>
  <% if @runs.any? %>
    <div class="space-y-3">
      <% @runs.each do |run| %>
        <%= render CardComponent.new(classes: "hover:bg-zinc-700 transition") do |c| %>
          <% c.with_body do %>
            <%= link_to run_path(run), class: "flex justify-between items-center" do %>
              <div>
                <h3 class="font-semibold">Run #<%= run.id %></h3>
                <div class="text-sm text-zinc-400 mt-1">
                  <span class="inline-block bg-zinc-700 rounded px-2 py-1"><%= run.status %></span>
                  <span class="ml-2"><%= pluralize(run.image_candidates.count, 'candidate') %></span>
                  <% if run.image_candidates.where(winner: true).any? %>
                    <span class="ml-2 text-green-600">‚úì Winner selected</span>
                  <% end %>
                </div>
              </div>
              <div class="text-zinc-400">
                <%= run.created_at.strftime('%b %d, %Y') %> ‚Üí
              </div>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <%= render CardComponent.new do |c| %>
      <% c.with_body do %>
        <div class="text-center text-zinc-400">
          <p>No runs yet.</p>
          <p class="text-sm mt-2">Create a pipeline run for this cluster to generate content.</p>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('photo-upload-form');
    const fileInput = form.querySelector('input[type="file"]');
    const uploadButton = document.getElementById('upload-button');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const feedbackDiv = document.getElementById('upload-feedback');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const files = fileInput.files;
      if (files.length === 0) {
        showFeedback('Please select at least one photo', 'error');
        return;
      }
      
      // Show progress
      uploadButton.disabled = true;
      uploadProgress.classList.remove('hidden');
      feedbackDiv.classList.add('hidden');
      progressBar.style.width = '50%';
      
      // Create FormData
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('photos[]', files[i]);
      }
      
      try {
        const clusterId = form.dataset.clusterId;
        const personaId = window.location.pathname.split('/')[2];
        const pillarId = window.location.pathname.split('/')[4];
        const url = `/personas/${personaId}/pillars/${pillarId}/clusters/${clusterId}/upload_photos`;
        
        const response = await fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        });
        
        const result = await response.json();
        progressBar.style.width = '100%';
        
        if (response.ok) {
          showFeedback(result.message, result.failed > 0 ? 'warning' : 'success');
          
          if (result.errors && result.errors.length > 0) {
            const errorList = result.errors.map(e => `${e.file}: ${e.error}`).join('<br>');
            showFeedback(result.message + '<br><br>Errors:<br>' + errorList, 'warning');
          }
          
          // Reload page to show new photos
          if (result.success > 0) {
            setTimeout(() => window.location.reload(), 1500);
          }
        } else {
          showFeedback(result.error || 'Upload failed', 'error');
        }
      } catch (error) {
        showFeedback('Network error: ' + error.message, 'error');
      } finally {
        uploadButton.disabled = false;
        setTimeout(() => {
          uploadProgress.classList.add('hidden');
          progressBar.style.width = '0%';
        }, 1000);
      }
    });
    
    function showFeedback(message, type) {
      const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        warning: 'bg-yellow-600'
      };
      
      feedbackDiv.className = `p-4 rounded ${colors[type] || colors.error} text-white`;
      feedbackDiv.innerHTML = message;
      feedbackDiv.classList.remove('hidden');
    }
  });
</script>
